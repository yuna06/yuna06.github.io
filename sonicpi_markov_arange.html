<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>Markov Chainモデルで作った曲を分析、アレンジしてみよう。</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Yuna06 </a></h1>
                <nav><ul>
                    <li><a href="/category/fa-xiao.html">発酵</a></li>
                    <li><a href="/category/foxdot.html">foxdot</a></li>
                    <li><a href="/category/genome.html">genome</a></li>
                    <li class="active"><a href="/category/sonicpi.html">sonicpi</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/sonicpi_markov_arange.html" rel="bookmark"
           title="Permalink to Markov Chainモデルで作った曲を分析、アレンジしてみよう。">Markov Chainモデルで作った曲を分析、アレンジしてみよう。</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2019-03-25T23:00:00+09:00">
                Published: Mon 25 March 2019
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/yuna06.html">yuna06</a>
        </address>
<p>In <a href="/category/sonicpi.html">sonicpi</a>.</p>
<p>tags: <a href="/tag/sonicpi.html">sonicpi</a> </p>
</footer><!-- /.post-info -->      <p style="margin-bottom:2em;">
今回はomar delarosaさんがSonic Piで作曲した <a href="https://www.youtube.com/watch?v=4SemYvZ58FU">ioxi - "Mondrian" (or Randomized Hip Hop + Sonic Pi + Drake)</a>を分析していきたいと思います。
<br>
<a href="https://github.com/omardelarosa/osc-browser-visualizers/blob/master/public/matrix-16x8/example-sonic-pi-driver.rb">GitHub</a>でコードが公開されていますし、<a href="https://www.youtube.com/watch?v=4SemYvZ58FU">YouTube</a>でも曲が公開されています。
</p>

<p style="margin-bottom:2em;">
<a href="https://yuna06.work/2019/01/23/%E3%83%9E%E3%83%AB%E3%82%B3%E3%83%95%E9%80%A3%E9%8E%96%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6sonic-pi%E3%81%A7beat%E3%82%92%E4%BD%9C%E3%82%8D%E3%81%86%E3%80%82/">マルコフ連鎖を使ってSONIC PIでBEATを作ろう。</a>で基幹システム部分の解説をしていますので、まずそちらをみていただくと良いと思います。
</p>

<h3>完成品を再生してみよう</h3>

<p style="margin-bottom:2em;">
いきなりですが、完成品をSonic Piで再生してみてください。

wzxhzdk:0


長いですが、一つ一つ理解していきましょう。<a href="https://yuna06.work/2019/01/23/%E3%83%9E%E3%83%AB%E3%82%B3%E3%83%95%E9%80%A3%E9%8E%96%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6sonic-pi%E3%81%A7beat%E3%82%92%E4%BD%9C%E3%82%8D%E3%81%86%E3%80%82/">マルコフ連鎖を使ってSONIC PIでBEATを作ろう。</a>で説明済みの部分は省略気味になります。
</p>

<h3>OCSを使ってウインドウと同期しよう</h3>

<p style="margin-bottom:2em;>

wzxhzdk:1

OSC（詳しくは<a href="https://yuna06.work/2019/01/26/osc%E3%82%92%E4%BD%BF%E3%81%8A%E3%81%86%e3%80%80sonic-pi/">OSCを使おう　SONIC PI</a>を参照）をSonic Piから送信しています。<code>"192.168.1.7"</code>がIPアドレス、<code>57121</code>がポート番号を示しています。これによってウインドウのOSCサーバーと同期できます。
</p>

<h3>マルコフチェーンモデル</h3>

<p style="margin-bottom:2em";>
<code># State machine utility functions</code>のブロックはマルコフチャーンモデルの心臓部分の関数定義を行なっています。最終的な関数は<code>mnote</code>で、演奏パターンを決定する役割を持っています。
<br>
<code>mnote</code>は二つ引数を持っており、第一引数に最初のパターン、第二引数に複数のパターンを持つdictを渡します。すると、第二引数のdictの中からマルコフニコフモデルに従って、一つのパターンを返すわけです。
</p>

<h3>メロディー関数</h3>

<p style="margin-bottom:2em";>
<code>:make_melody</code>では、<code>len</code>, <code>rng</code>でそれぞれメロディー音の長さとルート音からの距離を指定しています。
</p>

<h3>初期値設定</h3>

<p style="margin-bottom:2em";>
<code># Initialize states</code>のセクションでは<code>set</code>を使って演奏パターンの初期値を設定しています。マルコフニコフ連鎖モデルの初期値です。
</p>

<h3>初期値設定</h3>

<p style="margin-bottom:2em";>
下の<code>LV</code>ではコード以外の音量を決めています。0は演奏しない（音量ゼロ）、1は演奏するということになります。
<br>
最初に<code>0 => [0,0,0,0],</code>としておくことによって、0から1に変化できないので、音量はずっとゼロです。

wzxhzdk:2


<h3>:kick解説</h3>
<p style="margin-bottom:2em";>
300行近くあるスクリプトで変数も多いので混乱してしまうかもしれませんが、<code>live_loop :kick do</code>の部分を例に変数の意味を解説していきます。
<table>
  <caption>On_Off</caption>
  <tr>
    <th></th>
    <th></th>
    <th></th>
  </tr>
  <tr>
    <td>L</td>
    <td>```rubyL = {
  ppiano: [0.0, 0.35].ring,
  kick: [0.0, 0.75].ring,
  snare: [0.0, 0.75].ring,
  hats: [0.0, 1.5].ring,
  vox: [0.0, 5.0].ring
}```</td>
    <td>各楽器の最大音量と最小音量</td>
  </tr>
  <tr>
    <td>l_kick</td>
    <td>```rubyset :l_kick, 0```</td>
    <td>Lの初期値</td>
  </tr>
  </tr>
  <tr>
    <td>LV</td>
    <td>```rubyLV = {
  0 => [0,0,1,1],
  1 => [1,1,1,0]
}
```</td>
    <td>0なら最小音量、1なら最大音量。マルコフニコフ連鎖モデルの従う確率を決める。</td>
  </tr>
  </tr>
  <tr>
    <td>lv</td>
    <td>```rubylv = mnote :l_kick, LV```</td>
    <td><code>l_kick</code>を初期値にとって、LVの確率のマルコフニコフ連鎖モデルに従って0か1の値をとる。</td>
  </tr>
  <tr>
    <td>l</td>
    <td>```rubyl = L[:kick][lv]```</td>
    <td>Lのkickの中から要素を一つ選ぶ。今回は0.0 or 0.75</td>
  </tr>

</table>

<table>
  <caption>パターン</caption>
  <tr>
    <th></th>
    <th></th>
    <th></th>
  </tr>
  <tr>
    <td>b</td>
    <td>```rubyset :b, 0```</td>
    <td>Bの初期値</td>
  </tr>
  <tr>
    <td>B</td>
    <td>```rubyB = {
  0 => [0, 1, 0, 2],
  1 => [0],
  2 => [1, 0, 3],
  3 => [0]
}```</td>
    <td>演奏パターンをマルコフニコフ連鎖モデルで決める時の確率設定</td>
  </tr>
  <tr>
    <td>p1</td>
    <td>```rubyp1 = [
  (ringify '4000 0000 0040 0000'),
  (ringify '4020 0000 4000 0000'),
  (ringify '4023 0010 4020 0000'),
  (ringify '4030 0020 4020 1000')
]
```</td>
    <td>演奏パターン一覧</td>
  </tr>
  <tr>
    <td>p</td>
    <td>```rubyp = p1[mnote :b, B]```</td>
    <td>p1の中からパターンを一つ選んだものが入っている。</td>
  </tr>

</table>

</p>

<p style="margin-bottom:2em";>
<div class="box11">
<p>
・<code>l</code>に最大音量か最小音量か（実際は音を出すか出さないか）が格納
<br>
・<code>p</code>に演奏パターンが格納
</p>
</div>
上の表から最終的にpとlを使って最終アウトプットである演奏を操作していることがわかると思います。。
</p>

<p style="margin-bottom:2em";>

wzxhzdk:3

<code>density</code>は、pの配列の長さの半分の回数繰り返し演奏をさせています。<code>density</code>について詳しくは、<a href="https://yuna06.work/squash-and-repeat-time/">Squash and Repeat Time</a>を参考にしてください。
</p>

<h3>演奏をどう操るか？</h3>
<p style="margin-bottom:2em";>
システムの説明が多くなりましたが、実用的な話に移りましょう。
<br>
実際に演奏をする時はどのようにパラメーターを調整して演奏をコントロールすれば良いのでしょうか？
<br>
omar delarosaさんの演奏が実際に<a href="https://www.youtube.com/watch?v=4SemYvZ58FU">YouTube</a>で公開されていますので、そちらを見ると参考になると思います。
</p>

<h3>音量コントロール</h3>
<p style="margin-bottom:2em";>
基本は<code>L</code>と<code>LV</code>を操作して各楽器の音量調整をしています。以下の点を覚えておけば、大体コントロールできると思います。
<div class="box11">
<p>
・全ての楽器をミュートしたい時はLVを0に導くorLで全ての楽器の最大値最小値を0にする。
<br>
・演奏したい楽器とミュートしたい楽器がある人は、LVを1にも導きつつ、Lでミュートしたい楽器のみ最大値、最小値を0にする。
</p>
</div>
</p>

<h3>コードをコントロール</h3>
<p style="margin-bottom:2em";>
<code>K</code>を操作することでコードの変遷をコントロールすることができます。

wzxhzdk:4

デフォルトでは上のようになっていますが、<a href="https://www.youtube.com/watch?v=4SemYvZ58FU">demo動画</a>の途中では下のようにして、コードの数を制限してます。

wzxhzdk:5

</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>